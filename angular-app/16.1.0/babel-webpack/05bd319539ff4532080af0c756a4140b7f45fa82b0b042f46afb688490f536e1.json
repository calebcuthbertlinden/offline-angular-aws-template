{"ast":null,"code":"import { DEFAULT_COMPARATOR, groupBy, into, isEmpty, isObject, isString, resolve, sortBy } from \"../../util\";\n/**\n * Takes all input documents and returns them in a stream of sorted documents.\n *\n * @param collection\n * @param sortKeys\n * @param  {Object} options\n * @returns {*}\n */\nexport function $sort(collection, sortKeys, options) {\n  if (isEmpty(sortKeys) || !isObject(sortKeys)) return collection;\n  let cmp = DEFAULT_COMPARATOR;\n  // check for collation spec on the options\n  const collationSpec = options.collation;\n  // use collation comparator if provided\n  if (isObject(collationSpec) && isString(collationSpec.locale)) {\n    cmp = collationComparator(collationSpec);\n  }\n  return collection.transform(coll => {\n    const modifiers = Object.keys(sortKeys);\n    for (const key of modifiers.reverse()) {\n      const grouped = groupBy(coll, obj => resolve(obj, key), options?.hashFunction);\n      const sortedIndex = {};\n      const indexKeys = sortBy(grouped.keys, (k, i) => {\n        sortedIndex[k] = i;\n        return k;\n      }, cmp);\n      if (sortKeys[key] === -1) indexKeys.reverse();\n      coll = [];\n      for (const k of indexKeys) {\n        into(coll, grouped.groups[sortedIndex[k]]);\n      }\n    }\n    return coll;\n  });\n}\n// MongoDB collation strength to JS localeCompare sensitivity mapping.\n// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare\nconst COLLATION_STRENGTH = {\n  // Only strings that differ in base letters compare as unequal. Examples: a ≠ b, a = á, a = A.\n  1: \"base\",\n  //  Only strings that differ in base letters or accents and other diacritic marks compare as unequal.\n  // Examples: a ≠ b, a ≠ á, a = A.\n  2: \"accent\",\n  // Strings that differ in base letters, accents and other diacritic marks, or case compare as unequal.\n  // Other differences may also be taken into consideration. Examples: a ≠ b, a ≠ á, a ≠ A\n  3: \"variant\"\n  // case - Only strings that differ in base letters or case compare as unequal. Examples: a ≠ b, a = á, a ≠ A.\n};\n/**\n * Creates a comparator function for the given collation spec. See https://docs.mongodb.com/manual/reference/collation/\n *\n * @param spec {Object} The MongoDB collation spec.\n * {\n *   locale: string,\n *   caseLevel: boolean,\n *   caseFirst: string,\n *   strength: int,\n *   numericOrdering: boolean,\n *   alternate: string,\n *   maxVariable: string, // unsupported\n *   backwards: boolean // unsupported\n * }\n */\nfunction collationComparator(spec) {\n  const localeOpt = {\n    sensitivity: COLLATION_STRENGTH[spec.strength || 3],\n    caseFirst: spec.caseFirst === \"off\" ? \"false\" : spec.caseFirst || \"false\",\n    numeric: spec.numericOrdering || false,\n    ignorePunctuation: spec.alternate === \"shifted\"\n  };\n  // when caseLevel is true for strength  1:base and 2:accent, bump sensitivity to the nearest that supports case comparison\n  if ((spec.caseLevel || false) === true) {\n    if (localeOpt.sensitivity === \"base\") localeOpt.sensitivity = \"case\";\n    if (localeOpt.sensitivity === \"accent\") localeOpt.sensitivity = \"variant\";\n  }\n  const collator = new Intl.Collator(spec.locale, localeOpt);\n  return (a, b) => {\n    // non strings\n    if (!isString(a) || !isString(b)) return DEFAULT_COMPARATOR(a, b);\n    // only for strings\n    const i = collator.compare(a, b);\n    if (i < 0) return -1;\n    if (i > 0) return 1;\n    return 0;\n  };\n}","map":{"version":3,"names":["DEFAULT_COMPARATOR","groupBy","into","isEmpty","isObject","isString","resolve","sortBy","$sort","collection","sortKeys","options","cmp","collationSpec","collation","locale","collationComparator","transform","coll","modifiers","Object","keys","key","reverse","grouped","obj","hashFunction","sortedIndex","indexKeys","k","i","groups","COLLATION_STRENGTH","spec","localeOpt","sensitivity","strength","caseFirst","numeric","numericOrdering","ignorePunctuation","alternate","caseLevel","collator","Intl","Collator","a","b","compare"],"sources":["/Users/caleblinden/Documents/GitHub/mmf-poc/mmf-poc/node_modules/mingo/es/operators/pipeline/sort.js"],"sourcesContent":["import { DEFAULT_COMPARATOR, groupBy, into, isEmpty, isObject, isString, resolve, sortBy, } from \"../../util\";\n/**\n * Takes all input documents and returns them in a stream of sorted documents.\n *\n * @param collection\n * @param sortKeys\n * @param  {Object} options\n * @returns {*}\n */\nexport function $sort(collection, sortKeys, options) {\n    if (isEmpty(sortKeys) || !isObject(sortKeys))\n        return collection;\n    let cmp = DEFAULT_COMPARATOR;\n    // check for collation spec on the options\n    const collationSpec = options.collation;\n    // use collation comparator if provided\n    if (isObject(collationSpec) && isString(collationSpec.locale)) {\n        cmp = collationComparator(collationSpec);\n    }\n    return collection.transform((coll) => {\n        const modifiers = Object.keys(sortKeys);\n        for (const key of modifiers.reverse()) {\n            const grouped = groupBy(coll, (obj) => resolve(obj, key), options?.hashFunction);\n            const sortedIndex = {};\n            const indexKeys = sortBy(grouped.keys, (k, i) => {\n                sortedIndex[k] = i;\n                return k;\n            }, cmp);\n            if (sortKeys[key] === -1)\n                indexKeys.reverse();\n            coll = [];\n            for (const k of indexKeys) {\n                into(coll, grouped.groups[sortedIndex[k]]);\n            }\n        }\n        return coll;\n    });\n}\n// MongoDB collation strength to JS localeCompare sensitivity mapping.\n// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare\nconst COLLATION_STRENGTH = {\n    // Only strings that differ in base letters compare as unequal. Examples: a ≠ b, a = á, a = A.\n    1: \"base\",\n    //  Only strings that differ in base letters or accents and other diacritic marks compare as unequal.\n    // Examples: a ≠ b, a ≠ á, a = A.\n    2: \"accent\",\n    // Strings that differ in base letters, accents and other diacritic marks, or case compare as unequal.\n    // Other differences may also be taken into consideration. Examples: a ≠ b, a ≠ á, a ≠ A\n    3: \"variant\",\n    // case - Only strings that differ in base letters or case compare as unequal. Examples: a ≠ b, a = á, a ≠ A.\n};\n/**\n * Creates a comparator function for the given collation spec. See https://docs.mongodb.com/manual/reference/collation/\n *\n * @param spec {Object} The MongoDB collation spec.\n * {\n *   locale: string,\n *   caseLevel: boolean,\n *   caseFirst: string,\n *   strength: int,\n *   numericOrdering: boolean,\n *   alternate: string,\n *   maxVariable: string, // unsupported\n *   backwards: boolean // unsupported\n * }\n */\nfunction collationComparator(spec) {\n    const localeOpt = {\n        sensitivity: COLLATION_STRENGTH[spec.strength || 3],\n        caseFirst: spec.caseFirst === \"off\" ? \"false\" : spec.caseFirst || \"false\",\n        numeric: spec.numericOrdering || false,\n        ignorePunctuation: spec.alternate === \"shifted\",\n    };\n    // when caseLevel is true for strength  1:base and 2:accent, bump sensitivity to the nearest that supports case comparison\n    if ((spec.caseLevel || false) === true) {\n        if (localeOpt.sensitivity === \"base\")\n            localeOpt.sensitivity = \"case\";\n        if (localeOpt.sensitivity === \"accent\")\n            localeOpt.sensitivity = \"variant\";\n    }\n    const collator = new Intl.Collator(spec.locale, localeOpt);\n    return (a, b) => {\n        // non strings\n        if (!isString(a) || !isString(b))\n            return DEFAULT_COMPARATOR(a, b);\n        // only for strings\n        const i = collator.compare(a, b);\n        if (i < 0)\n            return -1;\n        if (i > 0)\n            return 1;\n        return 0;\n    };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}