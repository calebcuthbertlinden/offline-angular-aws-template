{"ast":null,"code":"import { randomToken } from './util.js';\nimport { sendLeaderMessage, beLeader } from './leader-election-util.js';\n\n/**\n * A faster version of the leader elector that uses the WebLock API\n * @link https://developer.mozilla.org/en-US/docs/Web/API/Web_Locks_API\n */\nexport var LeaderElectionWebLock = function LeaderElectionWebLock(broadcastChannel, options) {\n  var _this = this;\n  this.broadcastChannel = broadcastChannel;\n  broadcastChannel._befC.push(function () {\n    return _this.die();\n  });\n  this._options = options;\n  this.isLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  this._lstns = [];\n  this._unl = [];\n  this._dpL = function () {}; // onduplicate listener\n  this._dpLC = false; // true when onduplicate called\n\n  this._wKMC = {}; // stuff for cleanup\n\n  // lock name\n  this.lN = 'pubkey-bc||' + broadcastChannel.method.type + '||' + broadcastChannel.name;\n};\nLeaderElectionWebLock.prototype = {\n  hasLeader: function hasLeader() {\n    var _this2 = this;\n    return navigator.locks.query().then(function (locks) {\n      var relevantLocks = locks.held ? locks.held.filter(function (lock) {\n        return lock.name === _this2.lN;\n      }) : [];\n      if (relevantLocks && relevantLocks.length > 0) {\n        return true;\n      } else {\n        return false;\n      }\n    });\n  },\n  awaitLeadership: function awaitLeadership() {\n    var _this3 = this;\n    if (!this._wLMP) {\n      this._wKMC.c = new AbortController();\n      var returnPromise = new Promise(function (res, rej) {\n        _this3._wKMC.res = res;\n        _this3._wKMC.rej = rej;\n      });\n      this._wLMP = new Promise(function (res) {\n        navigator.locks.request(_this3.lN, {\n          signal: _this3._wKMC.c.signal\n        }, function () {\n          // if the lock resolved, we can drop the abort controller\n          _this3._wKMC.c = undefined;\n          beLeader(_this3);\n          res();\n          return returnPromise;\n        })[\"catch\"](function () {});\n      });\n    }\n    return this._wLMP;\n  },\n  set onduplicate(_fn) {\n    // Do nothing because there are no duplicates in the WebLock version\n  },\n  die: function die() {\n    var _this4 = this;\n    this._lstns.forEach(function (listener) {\n      return _this4.broadcastChannel.removeEventListener('internal', listener);\n    });\n    this._lstns = [];\n    this._unl.forEach(function (uFn) {\n      return uFn.remove();\n    });\n    this._unl = [];\n    if (this.isLeader) {\n      this.isLeader = false;\n    }\n    this.isDead = true;\n    if (this._wKMC.res) {\n      this._wKMC.res();\n    }\n    if (this._wKMC.c) {\n      this._wKMC.c.abort('LeaderElectionWebLock.die() called');\n    }\n    return sendLeaderMessage(this, 'death');\n  }\n};","map":{"version":3,"names":["randomToken","sendLeaderMessage","beLeader","LeaderElectionWebLock","broadcastChannel","options","_this","_befC","push","die","_options","isLeader","isDead","token","_lstns","_unl","_dpL","_dpLC","_wKMC","lN","method","type","name","prototype","hasLeader","_this2","navigator","locks","query","then","relevantLocks","held","filter","lock","length","awaitLeadership","_this3","_wLMP","c","AbortController","returnPromise","Promise","res","rej","request","signal","undefined","onduplicate","_fn","_this4","forEach","listener","removeEventListener","uFn","remove","abort"],"sources":["/Users/caleblinden/Documents/GitHub/mmf-poc/mmf-poc/node_modules/broadcast-channel/dist/esbrowser/leader-election-web-lock.js"],"sourcesContent":["import { randomToken } from './util.js';\nimport { sendLeaderMessage, beLeader } from './leader-election-util.js';\n\n/**\n * A faster version of the leader elector that uses the WebLock API\n * @link https://developer.mozilla.org/en-US/docs/Web/API/Web_Locks_API\n */\nexport var LeaderElectionWebLock = function LeaderElectionWebLock(broadcastChannel, options) {\n  var _this = this;\n  this.broadcastChannel = broadcastChannel;\n  broadcastChannel._befC.push(function () {\n    return _this.die();\n  });\n  this._options = options;\n  this.isLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  this._lstns = [];\n  this._unl = [];\n  this._dpL = function () {}; // onduplicate listener\n  this._dpLC = false; // true when onduplicate called\n\n  this._wKMC = {}; // stuff for cleanup\n\n  // lock name\n  this.lN = 'pubkey-bc||' + broadcastChannel.method.type + '||' + broadcastChannel.name;\n};\nLeaderElectionWebLock.prototype = {\n  hasLeader: function hasLeader() {\n    var _this2 = this;\n    return navigator.locks.query().then(function (locks) {\n      var relevantLocks = locks.held ? locks.held.filter(function (lock) {\n        return lock.name === _this2.lN;\n      }) : [];\n      if (relevantLocks && relevantLocks.length > 0) {\n        return true;\n      } else {\n        return false;\n      }\n    });\n  },\n  awaitLeadership: function awaitLeadership() {\n    var _this3 = this;\n    if (!this._wLMP) {\n      this._wKMC.c = new AbortController();\n      var returnPromise = new Promise(function (res, rej) {\n        _this3._wKMC.res = res;\n        _this3._wKMC.rej = rej;\n      });\n      this._wLMP = new Promise(function (res) {\n        navigator.locks.request(_this3.lN, {\n          signal: _this3._wKMC.c.signal\n        }, function () {\n          // if the lock resolved, we can drop the abort controller\n          _this3._wKMC.c = undefined;\n          beLeader(_this3);\n          res();\n          return returnPromise;\n        })[\"catch\"](function () {});\n      });\n    }\n    return this._wLMP;\n  },\n  set onduplicate(_fn) {\n    // Do nothing because there are no duplicates in the WebLock version\n  },\n  die: function die() {\n    var _this4 = this;\n    this._lstns.forEach(function (listener) {\n      return _this4.broadcastChannel.removeEventListener('internal', listener);\n    });\n    this._lstns = [];\n    this._unl.forEach(function (uFn) {\n      return uFn.remove();\n    });\n    this._unl = [];\n    if (this.isLeader) {\n      this.isLeader = false;\n    }\n    this.isDead = true;\n    if (this._wKMC.res) {\n      this._wKMC.res();\n    }\n    if (this._wKMC.c) {\n      this._wKMC.c.abort('LeaderElectionWebLock.die() called');\n    }\n    return sendLeaderMessage(this, 'death');\n  }\n};"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}